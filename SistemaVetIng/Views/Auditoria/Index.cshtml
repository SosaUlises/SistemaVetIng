@model SistemaVetIng.ViewsModels.AuditoriaViewModel
@using X.PagedList.Mvc.Core
@using X.PagedList
@using System.Globalization

@{
    ViewData["Title"] = "Auditoría del Sistema - VetIng";
    Layout = null;
    string controllerDestino = User.IsInRole("Veterinario") ? "Veterinario" : "Veterinaria";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

    <link rel="stylesheet" href="~/css/portal-theme.css" asp-append-version="true" />
</head>

<body>

    <header class="main-header">
        <a href="/Veterinaria/PaginaPrincipal" class="logo">
            <i class="fa-solid fa-paw"></i> VetIng
        </a>
        <nav class="main-nav">
            <ul class="nav-list" id="navMenu">
                <li><a class="nav-link" href="/Veterinaria/PaginaPrincipal">Volver al Panel</a></li>
                <li>
                    <form asp-controller="Account" asp-action="Logout" method="post">
                        <button type="submit" class="btn-logout">
                            <i class="fa-solid fa-right-from-bracket"></i> Salir
                        </button>
                    </form>
                </li>
            </ul>
        </nav>
        <div class="hamburger-menu" id="hamburgerBtn">
            <i class="fa-solid fa-bars"></i>
        </div>
    </header>

    <main class="main-content">
        
        <div class="dash-hero">
            <div class="dash-title">
                <h1>Registro de <span>Auditoría</span></h1>
                <p class="dash-subtitle">Historial de seguridad y movimientos del sistema.</p>
            </div>
        </div>

        <section>
            <div class="date-filter-card" style="display:block;"> 
                <form asp-action="Index" method="get" class="filter-grid-bar">
                    
                    <div class="form-group" style="margin:0;">
                        <label for="busquedaUsuario" class="form-label" style="color:white;">Usuario</label>
                        <input type="text" name="busquedaUsuario" id="busquedaUsuario" class="form-control" 
                               placeholder="Ej: admin@veting.com" value="@Model.BusquedaUsuario" />
                    </div>

                    <div class="form-group" style="margin:0;">
                        <label for="tipoEventoSeleccionado" class="form-label" style="color:white;">Evento</label>
                        <select name="tipoEventoSeleccionado" id="tipoEventoSeleccionado" class="form-control" 
                                asp-for="TipoEventoSeleccionado" asp-items="Model.TiposDeEvento">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin:0;">
                        <label for="fechaInicio" class="form-label" style="color:white;">Desde</label>
                        <input type="text" name="fechaInicio" id="fechaInicio" 
                               class="form-control calendar-input-fix" 
                               placeholder="Seleccionar..." 
                               value="@Model.FechaInicio?.ToString("yyyy-MM-dd")" readonly />
                    </div>

                    <div class="form-group" style="margin:0;">
                        <label for="fechaFin" class="form-label" style="color:white;">Hasta</label>
                        <input type="text" name="fechaFin" id="fechaFin" 
                               class="form-control calendar-input-fix" 
                               placeholder="Seleccionar..." 
                               value="@Model.FechaFin?.ToString("yyyy-MM-dd")" readonly />
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button type="submit" class="btn btn-primary btn-sm" style="flex:1;">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <a asp-action="Index" class="btn btn-outline btn-sm" style="flex:1; justify-content:center;">
                            <i class="fas fa-broom"></i> Limpiar
                        </a>
                    </div>

                </form>
            </div>
        </section>

        <section class="list-container">
            @if (Model.EventosPaginados != null && Model.EventosPaginados.Any())
            {
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Fecha y Hora</th>
                                <th class="text-center">Evento</th>
                                <th>Entidad</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var evento in Model.EventosPaginados)
                            {
                                <tr>
                                    <td data-label="Usuario">
                                        <div class="d-flex align-center gap-10">
                                            <i class="fa-solid fa-user-shield" style="color:var(--text-muted);"></i>
                                            <span class="text-name" style="font-size:0.95rem;">@evento.NombreUsuario</span>
                                        </div>
                                    </td>
                                    
                                    <td data-label="Fecha">
                                        <span class="text-mono" style="font-size:0.9rem;">
                                            @evento.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")
                                        </span>
                                    </td>
                                    
                                    <td data-label="Evento" class="text-center">
                                        @{
                                            string badgeClass = evento.TipoEvento switch {
                                                "Login Exitoso" => "audit-login",
                                                "Logout Exitoso" => "audit-logout",
                                                "Login Fallido" => "audit-fail",
                                                "Crear" => "audit-create",
                                                "Modificar" => "audit-update",
                                                "Eliminar" => "audit-delete",
                                                _ => "audit-logout"
                                            };
                                        }
                                        <span class="audit-badge @badgeClass">@evento.TipoEvento</span>
                                    </td>
                                    
                                  <td data-label="Entidad">
                                    @{
        
                                      var (textColorClass, entityIcon) = evento.Entidad switch
                                        {
                                            "Veterinario" => ("text-vet", "fa-user-doctor"),
                                            "Veterinaria" => ("text-clinic", "fa-hospital"),
                                            "Cliente"     => ("text-client", "fa-user"),
                                            _             => ("text-default", "fa-cube") // Default
                                        };
                                            }
    
                                            <span class="entity-text-wrap @textColorClass">
                                                <i class="fa-solid @entityIcon"></i> @evento.Entidad
                                            </span>
                                        </td>
                                    
                                    <td data-label="Detalle">
                                        <span style="color:var(--text-muted); font-size:0.9rem; font-style:italic;">
                                            @(!string.IsNullOrWhiteSpace(evento.Detalles) ? evento.Detalles : "-")
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="pagination-wrapper">
                    @if (Model.EventosPaginados.PageCount > 1)
                    {
                        @Html.PagedListPager(Model.EventosPaginados, page => Url.Action("Index",
                            new { 
                                page, 
                                busquedaUsuario = Model.BusquedaUsuario,
                                tipoEventoSeleccionado = Model.TipoEventoSeleccionado,
                                fechaInicio = Model.FechaInicio?.ToString("yyyy-MM-dd"),
                                fechaFin = Model.FechaFin?.ToString("yyyy-MM-dd")
                            }),
                            new PagedListRenderOptions {
                                LiElementClasses = new string[] { "page-item" },
                                PageClasses = new string[] { "page-link" },
                                ContainerDivClasses = new[] { "pagination" },
                                DisplayLinkToFirstPage = PagedListDisplayMode.Never,
                                DisplayLinkToLastPage = PagedListDisplayMode.Never
                            })
                    }
                    else
                    {
                        <p style="color:var(--text-muted); margin:0; font-size:0.9rem;">
                            Mostrando @Model.EventosPaginados.TotalItemCount registros.
                        </p>
                    }
                </div>
            }
            else
            {
                <div class="empty-state-container">
                    <div class="empty-search-icon">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                    <p>No se encontraron eventos de auditoría con los filtros actuales.</p>
                </div>
            }
        </section>

    </main>

    <footer class="main-footer">
        <div class="footer-bottom">
           <p>&copy; @DateTime.Now.Year VetIng Software. Desarrollado por Ulises Sosa y Leonel Gallaretto.</p>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/js/menuhamburguesa.js" asp-append-version="true"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    @await Component.InvokeAsync("NToastNotify")
    
    <script>
        const burger = document.getElementById('hamburgerBtn');
        const nav = document.getElementById('navMenu');
        if(burger && nav){
            burger.addEventListener('click', () => nav.classList.toggle('active'));
        }

        // Inicializar Calendarios
        document.addEventListener('DOMContentLoaded', function() {
            const config = {
                locale: "es",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                disableMobile: "true"
            };
            
            flatpickr("#fechaInicio", config);
            flatpickr("#fechaFin", config);
        });
    </script>
</body>
</html>